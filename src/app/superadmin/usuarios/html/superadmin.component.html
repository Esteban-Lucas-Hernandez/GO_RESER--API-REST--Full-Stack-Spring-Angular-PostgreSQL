<div class="superadmin-dashboard">
  <div class="dashboard-header">
    <h1>Panel de Super Administrador</h1>
    <div class="header-actions">
      <div class="search-container">
        <input
          type="text"
          placeholder="Buscar usuarios..."
          class="search-input"
          [(ngModel)]="searchTerm"
          (input)="filterUsers()"
        />
      </div>
      <button (click)="getUsers()" class="btn btn-refresh" [disabled]="loading">
        <span *ngIf="!loading">↻ Actualizar</span>
        <span *ngIf="loading">Actualizando...</span>
      </button>
    </div>
  </div>

  <div class="dashboard-content">
    <div class="stats-cards">
      <div class="stat-card">
        <h3>Total Usuarios</h3>
        <p class="stat-value">{{ usuarios.length }}</p>
      </div>
      <div class="stat-card">
        <h3>Usuarios Activos</h3>
        <p class="stat-value">{{ activeUsersCount }}</p>
      </div>
      <div class="stat-card">
        <h3>Administradores</h3>
        <p class="stat-value">{{ adminUsersCount }}</p>
      </div>
    </div>

    <div class="users-section">
      <div class="section-header">
        <h2>Gestión de Usuarios</h2>
        <div class="filter-tabs">
          <button
            class="tab-btn"
            [class.active]="activeFilter === 'all'"
            (click)="setFilter('all')"
          >
            Todos
          </button>
          <button
            class="tab-btn"
            [class.active]="activeFilter === 'active'"
            (click)="setFilter('active')"
          >
            Activos
          </button>
          <button
            class="tab-btn"
            [class.active]="activeFilter === 'inactive'"
            (click)="setFilter('inactive')"
          >
            Inactivos
          </button>
        </div>
      </div>

      <div *ngIf="loading" class="loading">
        <div class="spinner"></div>
        <p>Cargando usuarios...</p>
      </div>

      <div *ngIf="!loading && filteredUsers.length === 0" class="no-users">
        <p>No se encontraron usuarios que coincidan con los criterios.</p>
      </div>

      <div *ngIf="!loading && filteredUsers.length > 0" class="users-grid">
        <div
          *ngFor="let usuario of paginatedUsers"
          class="user-card"
          [class.inactive]="!usuario.estado"
        >
          <div class="user-header">
            <div class="user-avatar" *ngIf="!usuario.fotoUrl">
              {{ usuario.nombreCompleto.charAt(0) }}
            </div>
            <div class="user-image" *ngIf="usuario.fotoUrl">
              <img
                [src]="usuario.fotoUrl"
                [alt]="usuario.nombreCompleto"
                (error)="handleImageError(usuario)"
              />
            </div>
            <div class="user-info">
              <h3>{{ usuario.nombreCompleto }}</h3>
              <p class="user-email">{{ usuario.email }}</p>
            </div>
            <div class="user-status" [class.active]="usuario.estado">
              {{ usuario.estado ? 'Activo' : 'Inactivo' }}
            </div>
          </div>

          <div class="user-details">
            <div class="detail-row">
              <span class="detail-label">ID:</span>
              <span class="detail-value">{{ usuario.idUsuario }}</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">Teléfono:</span>
              <span class="detail-value">{{ usuario.telefono || 'No disponible' }}</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">Documento:</span>
              <span class="detail-value">{{ usuario.documento || 'No disponible' }}</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">Rol:</span>
              <span class="detail-value role-badge" [class]="getRoleClass(usuario.roles)">
                {{
                  usuario.roles && usuario.roles.length > 0
                    ? getRoleDisplayName(usuario.roles[0])
                    : 'Sin rol'
                }}
              </span>
            </div>
            <div class="detail-row">
              <span class="detail-label">Registro:</span>
              <span class="detail-value">{{ formatDate(usuario.fechaRegistro) }}</span>
            </div>
          </div>

          <div class="user-actions">
            <button
              (click)="openRoleChangeDialog(usuario)"
              class="btn btn-secondary btn-small"
              [disabled]="changingRole"
            >
              {{ changingRole ? 'Cambiando...' : 'Cambiar Rol' }}
            </button>

            <button
              (click)="changeUserStatus(usuario)"
              class="btn btn-toggle btn-small"
              [class.btn-activate]="!usuario.estado"
              [disabled]="changingStatus"
            >
              {{ usuario.estado ? 'Desactivar' : 'Activar' }}
            </button>

            <button
              (click)="deleteUser(usuario)"
              class="btn btn-danger btn-small"
              [disabled]="deletingUser"
            >
              {{ deletingUser ? 'Eliminando...' : 'Eliminar' }}
            </button>
          </div>
        </div>
      </div>

      <!-- Pagination Controls -->
      <div *ngIf="filteredUsers.length > 6" class="pagination-controls">
        <button class="btn-pagination" (click)="previousPage()" [disabled]="currentPage === 1">
          Anterior
        </button>

        <span class="pagination-info"> Página {{ currentPage }} de {{ totalPages }} </span>

        <button class="btn-pagination" (click)="nextPage()" [disabled]="currentPage === totalPages">
          Siguiente
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal para cambiar rol -->
<div *ngIf="showRoleChangeDialog" class="modal-overlay" (click)="closeRoleChangeDialog()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>Cambiar Rol de Usuario</h3>
      <button class="modal-close" (click)="closeRoleChangeDialog()">×</button>
    </div>

    <div class="modal-body" *ngIf="selectedUser">
      <p class="modal-subtitle">
        Selecciona el nuevo rol para <strong>{{ selectedUser.nombreCompleto }}</strong
        >:
      </p>

      <div class="role-options">
        <button
          *ngFor="let role of availableRoles"
          class="btn-role"
          [class.selected]="role === selectedRole"
          (click)="selectRole(role)"
        >
          <span class="role-name">{{ getRoleDisplayName(role) }}</span>
          <span class="role-desc">{{ getRoleDescription(role) }}</span>
        </button>
      </div>
    </div>

    <div class="modal-actions">
      <button class="btn btn-secondary" (click)="closeRoleChangeDialog()">Cancelar</button>
      <button
        class="btn btn-primary"
        (click)="confirmRoleChange()"
        [disabled]="!selectedRole || changingRole"
      >
        {{ changingRole ? 'Aplicando...' : 'Aplicar Cambio' }}
      </button>
    </div>
  </div>
</div>
